!function(e){e.setTrustedDomainList=function(t){if(!(t&&t instanceof Array))throw new TypeError("error trusted list");for(var s=0;s<t.length;s++){if("string"!=typeof t[s])throw new TypeError("error trusted list item, should be string",t[s]);if(!/https?:\/\/\w+/i.test(t[s]))throw new TypeError("error trusted list item, should be correct url",t[s])}e._trustedList=t},e.init=function(t){if(!window.postMessage)throw new Error("Your browser does not support postmessage");if(!e._inited){if(window.addEventListener("message",e._onPostMessage),!t||!t.postMessage)throw new Error("pmlib.init should be a correct or postMessage supported window object");e.receive("initAsk",function(t){e._postMessageName=t._postmessagename||e._postmessagename,e.refuse("initAsk"),"usePostMessage"===t.data.ask&&(e._send({_postmessagename:e._postMessageName,window:window.parent,type:"_response",data:{response:"yes"}}),e._inited=!0,e._readyCall())}),e._send({_postmessagename:"init",window:t,type:"_postMessageInited",data:{_inited:!0}})}},e.initServer=function(){if(!window.postMessage)throw new Error("Your browser does not support postmessage");window.addEventListener("message",e._onPostMessage),e._inited=!0},e.send=function(t,s){if(e._inited)if(e._messagePool.length>0){e._messagePool.push({info:t,errorback:s});for(var n;e._messagePool.length;)n=e._messagePool.shift(),e._send(n.info,n.errorback)}else e._send(t,s);else e._messagePool.push({info:t,errorback:s})},e.receive=function(){var t,s;if(2===arguments.length?"string"==typeof arguments[0]&&"function"==typeof arguments[1]&&(t=arguments[0],s=arguments[1]):1===arguments.length&&"function"==typeof arguments[0]&&(s=arguments[0]),!t&&!s)throw new Error("pmlib.receive arguments error");if(e._hasListener(t||n));else{var n={};n.name=t||"handler"+Math.random().toString().slice(1),n.handler=s,e._addListener(n)}},e.refuse=function(){var t,s;if(2===arguments.length?"string"==typeof arguments[0]&&"function"==typeof arguments[1]&&(t=arguments[0],s=arguments[1]):1===arguments.length&&("function"==typeof arguments[0]?s=arguments[0]:"string"==typeof arguments[0]&&(t=arguments[0])),!t&&!s)throw new Error("pmlib.refuse arguments error");e._hasListener(t||s)&&e._removeListener(t||s)},e._listener=[],e._trustedList=[],e._inited=!1,e._postMessageName=Math.random().toString().slice(2),e._messagePool=[],e._readyCall=function(){if(e._messagePool.length>0)for(var t;e._messagePool.length;)t=e._messagePool.shift(),e._send(t.info,t.errorback)},e._hasListener=function(t){for(var s=0;s<e._listener.length;s++)if("string"==typeof t&&e._listener[s].name===t||"function"==typeof t&&e._listener[s].handler===t)return!0;return!1},e._addListener=function(t){return e._listener.push(t),!0},e._removeListener=function(t){if(e._hasListener(t))for(var s=0;s<e._listener.length;s++)("string"==typeof t&&e._listener[s].name===t||"function"==typeof t&&e._listener[s].handler===t)&&(e._listener.splice(s,1),s-=1);return!0},e._onPostMessage=function(t){if(e._trustedList.indexOf(t.origin)>-1){if("_postMessageInited"===t.data.type)e._getListenerHandler("init")(t.data,t.source);else if("_ask"===t.data.type)e._getListenerHandler("initAsk")(t.data);else if(t.data._postmessagename)for(var s=0;s<e._listener.length;s++)if(e._listener[s].name===t.data._postmessagename){e._listener[s].handler(t.data,t.source);break}for(s=0;s<e._listener.length;s++)/handler.\d+/i.test(e._listener[s].name)&&e._listener[s].handler(t.data,t.source)}},e._send=function(t,s){if(t.window&&t.window.postMessage){!t._postmessagename&&(t._postmessagename=e._postMessageName),!t.type&&(t.type="message");var n=t.window;delete t.window,n.postMessage(t,"*")}else s&&"function"==typeof s&&s("window error")},e._getListenerHandler=function(t){for(var s=0;s<e._listener.length;s++)if(e._listener[s].name===t)return e._listener[s].handler}}(window.pmlib=window.pmlib||{});